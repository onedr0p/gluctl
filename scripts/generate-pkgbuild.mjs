#!/usr/bin/env zx
import { os, fs, argv } from 'zx'

if (argv.h || argv.help) {
  console.log(`${argv._} --release-tag [--pkg-release] [--checksum-file] [--output-dir]`)
  process.exit(0)
}

const maintainer = 'Toboshii Nakama <toboshii at gmail dot com>'
const sourceUrl = 'https://github.com/onedr0p/gluctl'
const tag = argv['release-tag'] || argv.t || process.env.RELEASE_TAG
const pkgRelease = argv['pkg-release'] || process.env.PKG_RELEASE || 1
const checksumFile = argv['checksum-file'] || argv.c || process.env.CHECKSUM_FILE || './dist/checksums.txt'
const outputDir = argv['output-dir'] || argv.o || process.env.OUTPUT_DIR || `${os.tmpdir()}/pkgbuild/gluctl-bin`

if (!tag) {
  throw new Error('Argument --release-tag, -t, or env RELEASE_TAG not set')
}

const checksumBuffer = await fs.readFile(checksumFile)
const checksums = checksumBuffer.toString().trim().split('\n').reduce((checksums, line) => {
  const parts = line.split(/\s+/)
  checksums[parts[1]] = parts[0]
  return checksums
}, {})

console.log('Generating PKGBUILD for gluctl-bin...')
const pkgbuildFile = `${outputDir}/PKGBUILD`
await fs.mkdirp(outputDir)
await fs.remove(pkgbuildFile)

const pkgbuild = fs.createWriteStream(pkgbuildFile, { mode: 0o755 })

const template = `# This file is automatically generated. Do not edit.
# Maintainer: ${maintainer}

pkgname='gluctl-bin'
pkgver=${tag}
pkgrel=${pkgRelease}
pkgdesc='The glue that helps maintain a Kubernetes Home Lab'
arch=('aarch64' 'x86_64')
url='https://github.com/onedr0p/gluctl'
license=('custom:WTFPL')
provides=('gluctl')
conflicts=('gluctl')
options=(!strip)

source=('https://raw.githubusercontent.com/onedr0p/gluctl/${tag}/LICENSE.md')
sha256sums=(SKIP)

source_aarch64=("\${pkgname}_\${pkgver}::${sourceUrl}/releases/download/${tag}/gluctl-linux-arm64")
sha256sums_aarch64=('${checksums['gluctl-linux-arm64']}')

source_x86_64=("\${pkgname}_\${pkgver}::${sourceUrl}/releases/download/${tag}/gluctl-linux-amd64")
sha256sums_x86_64=('${checksums['gluctl-linux-amd64']}')

package() {
  # bin
  install -Dm755 "./\${pkgname}_\${pkgver}" "\${pkgdir}/usr/bin/gluctl"
  # license
  install -Dm644 "./LICENSE.md" "\${pkgdir}/usr/share/licenses/gluctl/LICENSE.md"
}
`
pkgbuild.write(template)

pkgbuild.end()
